#!/bin/sh

set -e

BUILD_DIR=$1
CACHE_DIR=$2
VENDOR_DIR="${BUILD_DIR}/vendor"
ENVIRONMENT="ubuntu_x86_64"
PHANTOMJS_NAME="phantomjs"
PHANTOMJS_VERSION="2.0.0"
PHANTOM_JS_PACKAGE_BASE_URL="https://timscott-binaries.s3.amazonaws.com"
PHANTOMJS_PACKAGE_FILENAME="${PHANTOMJS_NAME}-${PHANTOMJS_VERSION}-${ENVIRONMENT}.zip"
PHANTOMJS_PACKAGE_URL="${PHANTOM_JS_PACKAGE_BASE_URL}/${PHANTOMJS_PACKAGE_FILENAME}"
PHANTOMJS_PACKAGE_PATH="${CACHE_DIR}/${PHANTOMJS_PACKAGE_FILENAME}"
PHANTOMJS_DIR="${VENDOR_DIR}/${PHANTOMJS_NAME}"
PHANTOMJS_BINARY_PATH="${PHANTOMJS_DIR}/bin/${PHANTOMJS_NAME}"
CASPER_REPO="git://github.com/timscott/casperjs.git"
CASPERJS_BRANCH="phantomjs-2"

mkdir -p $CACHE_DIR

if ! [ -e $PHANTOMJS_PACKAGE_PATH ]; then
  echo "-----> Fetching PhantomJS buildpack binaries from ${PHANTOMJS_PACKAGE_URL} to ${PHANTOMJS_PACKAGE_PATH}"
  curl $PHANTOMJS_PACKAGE_URL --verbose -L -s -o $PHANTOMJS_PACKAGE_PATH
fi

echo "-----> Extracting PhantomJS binaries from ${PHANTOMJS_PACKAGE_PATH} to ${PHANTOMJS_DIR}"
mkdir -p $PHANTOMJS_DIR
cd $PHANTOMJS_DIR
jar xf $PHANTOMJS_PACKAGE_PATH
# chmod +x $PHANTOMJS_BINARY_PATH

echo "-----> Cloning casperjs from ${CASPER_REPO} and checking out ${CASPERJS_BRANCH}"
cd $VENDOR_DIR
git clone $CASPER_REPO
cd casperjs
git checkout $CASPERJS_BRANCH